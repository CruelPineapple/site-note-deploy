<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scheduler | 一个云鬼</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="我悲痛欲绝，跳进了家门口的井里">
    
    <link rel="preload" href="/note/assets/css/0.styles.ba1ec7e7.css" as="style"><link rel="preload" href="/note/assets/js/app.5fd906df.js" as="script"><link rel="preload" href="/note/assets/js/2.928e56f7.js" as="script"><link rel="preload" href="/note/assets/js/28.25ad1a6a.js" as="script"><link rel="prefetch" href="/note/assets/js/10.10e9bba5.js"><link rel="prefetch" href="/note/assets/js/100.a94b9cbb.js"><link rel="prefetch" href="/note/assets/js/101.ef3d7c05.js"><link rel="prefetch" href="/note/assets/js/102.d28a302b.js"><link rel="prefetch" href="/note/assets/js/103.90ae85f3.js"><link rel="prefetch" href="/note/assets/js/104.0e860911.js"><link rel="prefetch" href="/note/assets/js/105.a7d37867.js"><link rel="prefetch" href="/note/assets/js/106.009b2257.js"><link rel="prefetch" href="/note/assets/js/107.893340fe.js"><link rel="prefetch" href="/note/assets/js/108.54a0fe64.js"><link rel="prefetch" href="/note/assets/js/109.25d0d449.js"><link rel="prefetch" href="/note/assets/js/11.21d5ce58.js"><link rel="prefetch" href="/note/assets/js/110.9132dd1d.js"><link rel="prefetch" href="/note/assets/js/111.f05f72b9.js"><link rel="prefetch" href="/note/assets/js/112.ad04da5d.js"><link rel="prefetch" href="/note/assets/js/113.66b08eef.js"><link rel="prefetch" href="/note/assets/js/114.39315e5e.js"><link rel="prefetch" href="/note/assets/js/115.8a3d6632.js"><link rel="prefetch" href="/note/assets/js/116.157c0189.js"><link rel="prefetch" href="/note/assets/js/117.b2a54781.js"><link rel="prefetch" href="/note/assets/js/118.5de6d1af.js"><link rel="prefetch" href="/note/assets/js/119.c88cb3c3.js"><link rel="prefetch" href="/note/assets/js/12.29c8ed4d.js"><link rel="prefetch" href="/note/assets/js/120.feb8b9b4.js"><link rel="prefetch" href="/note/assets/js/13.82cfd006.js"><link rel="prefetch" href="/note/assets/js/14.bf5fe31c.js"><link rel="prefetch" href="/note/assets/js/15.506bafed.js"><link rel="prefetch" href="/note/assets/js/16.d793cd34.js"><link rel="prefetch" href="/note/assets/js/17.f649bf09.js"><link rel="prefetch" href="/note/assets/js/18.bdef5aa2.js"><link rel="prefetch" href="/note/assets/js/19.948090ea.js"><link rel="prefetch" href="/note/assets/js/20.7d58ebce.js"><link rel="prefetch" href="/note/assets/js/21.880bfe28.js"><link rel="prefetch" href="/note/assets/js/22.7016d03a.js"><link rel="prefetch" href="/note/assets/js/23.81195b7c.js"><link rel="prefetch" href="/note/assets/js/24.7711513c.js"><link rel="prefetch" href="/note/assets/js/25.fee8edc1.js"><link rel="prefetch" href="/note/assets/js/26.0621e629.js"><link rel="prefetch" href="/note/assets/js/27.efffe887.js"><link rel="prefetch" href="/note/assets/js/29.0334965c.js"><link rel="prefetch" href="/note/assets/js/3.0d14c112.js"><link rel="prefetch" href="/note/assets/js/30.2483f6c5.js"><link rel="prefetch" href="/note/assets/js/31.92fe43d0.js"><link rel="prefetch" href="/note/assets/js/32.8a485378.js"><link rel="prefetch" href="/note/assets/js/33.a8798b43.js"><link rel="prefetch" href="/note/assets/js/34.cc5641c6.js"><link rel="prefetch" href="/note/assets/js/35.20bedc1f.js"><link rel="prefetch" href="/note/assets/js/36.7bc8fad0.js"><link rel="prefetch" href="/note/assets/js/37.84ff4ffd.js"><link rel="prefetch" href="/note/assets/js/38.5453e35b.js"><link rel="prefetch" href="/note/assets/js/39.e22e0685.js"><link rel="prefetch" href="/note/assets/js/4.e05c873c.js"><link rel="prefetch" href="/note/assets/js/40.b3f4c779.js"><link rel="prefetch" href="/note/assets/js/41.139c041f.js"><link rel="prefetch" href="/note/assets/js/42.f151c5e7.js"><link rel="prefetch" href="/note/assets/js/43.57ff566b.js"><link rel="prefetch" href="/note/assets/js/44.0b445793.js"><link rel="prefetch" href="/note/assets/js/45.44f6dd90.js"><link rel="prefetch" href="/note/assets/js/46.bc9bb654.js"><link rel="prefetch" href="/note/assets/js/47.3cef9ff3.js"><link rel="prefetch" href="/note/assets/js/48.f9793a03.js"><link rel="prefetch" href="/note/assets/js/49.c06eff13.js"><link rel="prefetch" href="/note/assets/js/5.76fc70b2.js"><link rel="prefetch" href="/note/assets/js/50.0b5e7ea8.js"><link rel="prefetch" href="/note/assets/js/51.9ff5dac7.js"><link rel="prefetch" href="/note/assets/js/52.f38322be.js"><link rel="prefetch" href="/note/assets/js/53.2a19a697.js"><link rel="prefetch" href="/note/assets/js/54.df0b200f.js"><link rel="prefetch" href="/note/assets/js/55.1c7041a2.js"><link rel="prefetch" href="/note/assets/js/56.2a8d0981.js"><link rel="prefetch" href="/note/assets/js/57.4bebd120.js"><link rel="prefetch" href="/note/assets/js/58.6b181819.js"><link rel="prefetch" href="/note/assets/js/59.1c15d656.js"><link rel="prefetch" href="/note/assets/js/6.498ab014.js"><link rel="prefetch" href="/note/assets/js/60.b48b5116.js"><link rel="prefetch" href="/note/assets/js/61.79a49711.js"><link rel="prefetch" href="/note/assets/js/62.53fd3e48.js"><link rel="prefetch" href="/note/assets/js/63.ae4350bf.js"><link rel="prefetch" href="/note/assets/js/64.a9647e13.js"><link rel="prefetch" href="/note/assets/js/65.1b80757e.js"><link rel="prefetch" href="/note/assets/js/66.78a1e543.js"><link rel="prefetch" href="/note/assets/js/67.f2fa88d9.js"><link rel="prefetch" href="/note/assets/js/68.35852ab3.js"><link rel="prefetch" href="/note/assets/js/69.9401cced.js"><link rel="prefetch" href="/note/assets/js/7.f2df6e20.js"><link rel="prefetch" href="/note/assets/js/70.c32325b0.js"><link rel="prefetch" href="/note/assets/js/71.d3a06ac0.js"><link rel="prefetch" href="/note/assets/js/72.953e831f.js"><link rel="prefetch" href="/note/assets/js/73.500bd846.js"><link rel="prefetch" href="/note/assets/js/74.6b777938.js"><link rel="prefetch" href="/note/assets/js/75.4a80bc45.js"><link rel="prefetch" href="/note/assets/js/76.f2879596.js"><link rel="prefetch" href="/note/assets/js/77.963a7fbd.js"><link rel="prefetch" href="/note/assets/js/78.343dc9c8.js"><link rel="prefetch" href="/note/assets/js/79.42c32438.js"><link rel="prefetch" href="/note/assets/js/8.850337c0.js"><link rel="prefetch" href="/note/assets/js/80.8ed82e29.js"><link rel="prefetch" href="/note/assets/js/81.d181093a.js"><link rel="prefetch" href="/note/assets/js/82.a0c095fd.js"><link rel="prefetch" href="/note/assets/js/83.25f4a0f2.js"><link rel="prefetch" href="/note/assets/js/84.98244c88.js"><link rel="prefetch" href="/note/assets/js/85.965be316.js"><link rel="prefetch" href="/note/assets/js/86.f096a094.js"><link rel="prefetch" href="/note/assets/js/87.c13e0ee7.js"><link rel="prefetch" href="/note/assets/js/88.b59385c4.js"><link rel="prefetch" href="/note/assets/js/89.b9098cf7.js"><link rel="prefetch" href="/note/assets/js/9.232f7918.js"><link rel="prefetch" href="/note/assets/js/90.1103cbde.js"><link rel="prefetch" href="/note/assets/js/91.4a4a95d8.js"><link rel="prefetch" href="/note/assets/js/92.25b5fde4.js"><link rel="prefetch" href="/note/assets/js/93.cac159b4.js"><link rel="prefetch" href="/note/assets/js/94.5671bffb.js"><link rel="prefetch" href="/note/assets/js/95.510ad048.js"><link rel="prefetch" href="/note/assets/js/96.c372c604.js"><link rel="prefetch" href="/note/assets/js/97.6af9dfa7.js"><link rel="prefetch" href="/note/assets/js/98.7922b18c.js"><link rel="prefetch" href="/note/assets/js/99.05bf90e9.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.ba1ec7e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">一个云鬼</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/Fe/" class="nav-link router-link-active">
  Note
</a></div><div class="nav-item"><a href="/note/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/CruelPineapple" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/Fe/" class="nav-link router-link-active">
  Note
</a></div><div class="nav-item"><a href="/note/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/CruelPineapple" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/Fe/react/scheduler.html" aria-current="page" class="active sidebar-link">Scheduler</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#基础时间分片" class="sidebar-link">基础时间分片</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#scheduler-2" class="sidebar-link">Scheduler</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#getcurrenttime" class="sidebar-link">getCurrentTime</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#request-cancel-hosttimeout" class="sidebar-link">request/cancel HostTimeout</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#handletimeout" class="sidebar-link">handleTimeout</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#advancedtimers" class="sidebar-link">advancedTimers</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#requesthostcallback" class="sidebar-link">requestHostCallback</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#performworkuntildeadline" class="sidebar-link">performWorkUntilDeadline</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#flushwork" class="sidebar-link">flushWork</a></li><li class="sidebar-sub-header"><a href="/note/Fe/react/scheduler.html#workloop" class="sidebar-link">workLoop</a></li></ul></li><li><a href="/note/Fe/react/fiber.html" class="sidebar-link">Fiber</a></li><li><a href="/note/Fe/react/调和.html" class="sidebar-link">协调（Reconciliation）</a></li><li><a href="/note/Fe/react/diff.html" class="sidebar-link">diff</a></li><li><a href="/note/Fe/react/react哲学.html" class="sidebar-link">react哲学--锐评ASD</a></li><li><a href="/note/Fe/react/hook-asd.html" class="sidebar-link">HOOK-ASD</a></li><li><a href="/note/Fe/react/asd.html" class="sidebar-link">A-SOUL Digits</a></li><li><a href="/note/Fe/react/类.html" class="sidebar-link">类</a></li><li><a href="/note/Fe/react/Symbol.html" class="sidebar-link">Symbol</a></li><li><a href="/note/Fe/react/for.html" class="sidebar-link">For</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>红宝书笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>我不知道的JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>方法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> Scheduler</h1> <p>浏览器无法同时响应JS任务和UI操作任务，如果一个同步任务占用时间很长，就会导致掉帧和卡顿。因此需要把一个耗时的任务及时中断掉，把主线程归还给浏览器去执行更重要的任务（比如用户交互），后续再执行该耗时任务。React采用时间分片的策略，将任务细分为不同优先级，利用浏览器空闲的时间进行任务执行以确保UI操作是流畅的。</p> <p>scheduler对于单个任务进行节制地执行，多个任务按优先级执行。多个任务会区分未过期任务和已过期任务，已经过期的任务就送进taskQueue，未过期则是timerQueue</p> <p>进入队列的任务会进行排列（目前优先队列使用小顶堆实现，老版本是循环链表），timerQueue根据任务开始时间排序，开始的早就需要早点执行，taskQueue根据过期时间排序，过期时间小说明过期的早，需要排在前面执行</p> <p>在归还主线程给浏览器时，react使用了<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel" target="_blank" rel="noopener noreferrer">messageChannel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来产生一个宏任务，从而让任务在下一个循环中再继续执行。<a href="https://juejin.cn/post/6953804914715803678" target="_blank" rel="noopener noreferrer">为什么使用messageChannel 产生宏任务而不是setTimeout或者rAF<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>和scheduler交互主要流程如下：</p> <ol><li>react组件状态更新，向scheduler提交一个任务要求执行更新方法（例如虚拟dom更新等）</li> <li>scheduler调度该任务，执行更新方法</li> <li>react在调和阶段（UI更新的过程）更新了一个fiber之后，会询问scheduleer是否需要暂停，如果不需要才会继续更新下一个fiber</li> <li>如果要暂停，react就会给scheduler返回一个函数，用于告知scheduler任务还没完成，让它在未来继续调度</li></ol> <p>第一步中，scheduler需要暴露pushTask方法，让react存入任务</p> <p>第二步中，scheduler需要暴露scheduleTask方法，用于调度任务</p> <p>第三步中，scheduler需要暴露shouldYield方法，react通过该方法决定是否需要暂停执行</p> <p>第四步中，scheduler判断返回值是否为函数，如果是则说明任务未完成，将来还需要调度</p> <h2 id="基础时间分片"><a href="#基础时间分片" class="header-anchor">#</a> 基础时间分片</h2> <p>浏览器的调度API有两个，高优先级的requestAnimationFrame和低优先级的requestIdleCallback。不过现在react已经不用rAF了</p> <h3 id="requestanimationframe"><a href="#requestanimationframe" class="header-anchor">#</a> requestAnimationFrame</h3> <p>这个函数在浏览器绘制每一帧的开始的时候执行，接收一个参数为<a href="https://link.zhihu.com/?target=https%3A//developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp" target="_blank" rel="noopener noreferrer">DOMHighResTimeStamp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的回调函数作为参数，返回一个供calcelAnimationFrame方法取消的id</p> <p>可以使用这个Api实现一个简单的时间分片调度：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// create 1000 tasks </span>
<span class="token keyword">const</span> tasks <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'task run'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//创建了一个长度1000点array，每个成员是一个任务，任务就是打印task run</span>

<span class="token keyword">const</span> <span class="token function-variable function">doTasks</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fromIndex <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> i <span class="token operator">=</span> fromIndex<span class="token punctuation">;</span>
	<span class="token keyword">let</span> end<span class="token punctuation">;</span>
	
	<span class="token keyword">do</span> <span class="token punctuation">{</span>
		tasks<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do task</span>
		end <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> tasks<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> end <span class="token operator">-</span> start <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Do tasks in 2ms</span>
	<span class="token comment">// 原本的代码是一帧执行20ms，但是我寻思60hz的一帧也就16.7ms，就改成了2ms</span>
  <span class="token comment">// 反正意思是一样的，这样我理解起来更方便，就是一帧里面抽空执行了2ms</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tasks remain: '</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// if remaining tasks exsis when timeout. Run at next frame</span>
  <span class="token comment">// 活没干完，在下一次rAF的时候再干</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token function">doTasks</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// start tasks scheduler</span>
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token function">doTasks</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 输出，xx task run这个数字是console里面自动折叠的那个数字，就是表示连续输出了多少个</span>
<span class="token number">33</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">967</span>
<span class="token number">55</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">912</span>
<span class="token number">49</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">863</span>
<span class="token number">52</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">811</span>
<span class="token number">48</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">763</span>
<span class="token number">42</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">721</span>
<span class="token number">40</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">681</span>
<span class="token number">42</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">639</span>
<span class="token number">70</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">569</span>
<span class="token number">51</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">518</span>
<span class="token number">46</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">472</span>
<span class="token number">51</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">421</span>
<span class="token number">60</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">361</span>
<span class="token number">46</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">315</span>
<span class="token number">65</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">250</span>
<span class="token number">75</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">175</span>
<span class="token number">49</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">126</span>
<span class="token number">70</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">56</span>
<span class="token number">56</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">0</span>
</code></pre></div><p>原文说的是“每帧留出20ms执行js任务”但我觉得，每秒60帧的话，一帧就16.7ms，所以感觉不太对，就改成了每次执行2ms的任务，下面也顺着2ms来</p> <p>然后，这里是2ms全都用来执行任务了，如果一个任务在2ms之内就干完了，多出来的时间怎么办呢，就引入了requestIdleCallback</p> <h3 id="requestidlecallback"><a href="#requestidlecallback" class="header-anchor">#</a> requestIdleCallback</h3> <p>优先级比rAF要低，仅当浏览器空闲才会执行的任务调度。接收两个参数，第一个是接受<a href="https://link.zhihu.com/?target=https%3A//developer.mozilla.org/zh-CN/docs/Web/API/IdleDeadline" target="_blank" rel="noopener noreferrer">IdleDeadline<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（一个内置属性，用于得知预估的当前闲置周期剩余时间）参数的回调，第二个参数是一个可选的options，包括一个timeout设置项，可以指定回调超时的时间以防它饿死（到达timeout值却还未执行的回调将直接进入事件循环中排队，但是就不保证执行顺序了而且可能影响性能）</p> <p>使用requestIdleCallback的调度是这样的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> tasks <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'task run'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">doTasks</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fromIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> idleDeadline</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> i <span class="token operator">=</span> fromIndex<span class="token punctuation">;</span>
	<span class="token keyword">let</span> end<span class="token punctuation">;</span>
	
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'time remains: '</span><span class="token punctuation">,</span> idleDeadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// timeRemaining方法取得当前闲置周期预估的剩余时间（ms）</span>
	<span class="token keyword">do</span> <span class="token punctuation">{</span>
		tasks<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do task</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> tasks<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> idleDeadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只要有剩余时间就干活</span>
	
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tasks remain: '</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// if remaining tasks exsis when timeout. Run at next frame</span>
  <span class="token comment">// 活没干完，在下一个周期有空的时候干</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token function">doTasks</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// start tasks scheduler</span>
<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token function">doTasks</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 输出</span>
time remains<span class="token operator">:</span>  <span class="token number">6.8</span>
<span class="token number">88</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">912</span>
 time remains<span class="token operator">:</span>  <span class="token number">14.9</span>
<span class="token number">282</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">630</span>
 time remains<span class="token operator">:</span>  <span class="token number">15.3</span>
<span class="token number">328</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">302</span>
 time remains<span class="token operator">:</span>  <span class="token number">15.3</span>
<span class="token number">302</span> task run
 tasks remain<span class="token operator">:</span>  <span class="token number">0</span>
</code></pre></div><p>一般剩的时间都有15ms左右。但是在任务复杂的时候，可能会导致任务堆积，这时候可选参数的timeout就可以让某些任务及时执行。</p> <p>另外requestIdleCallback在safari里面是没有的</p> <h2 id="scheduler-2"><a href="#scheduler-2" class="header-anchor">#</a> Scheduler</h2> <p>react借鉴了requestIdleCallback的模式。在react中，任务优先级有immediate，UserBlocking，normal，low，idle五种，每一种任务也有各自的超时时间，避免任务饿死。</p> <p>scheduler的入口是scheduleCallback，它负责生成调度任务，根据任务是否过期将其放入timerQueue和taskQueue，然后触发调度行为，让任务进入调度。大致过程如下：</p> <ol><li>计算startTime，用作timerQueue排序的依据，getCurrentTime用于获取当前时间</li> <li>接着计算expirationTime（到期时间），用作taskQueue的排序依据</li> <li>newTask是scheduler中任务单元的数据结构</li> <li>根据1，2步计算的时间，把task放进对应的队列，然后触发调度</li></ol> <p>入口的具体实现如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*
   * (1
   */</span>
  <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// timerQueue 根据 startTime 排序</span>
  <span class="token comment">// 任务进来的时候, 开始时间默认是当前时间, 如果进入调度的时候传了延迟时间</span>
  <span class="token comment">// 开始时间则是当前时间与延迟时间的和</span>
  <span class="token keyword">var</span> startTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> options <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> delay <span class="token operator">=</span> options<span class="token punctuation">.</span>delay<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> delay <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * (2
   */</span>
  <span class="token comment">// taskQueue 根据 expirationTime 排序</span>
  <span class="token keyword">var</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> ImmediatePriority<span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span> <span class="token comment">// -1</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> UserBlockingPriority<span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">USER_BLOCKING_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span> <span class="token comment">// 250</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> IdlePriority<span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">IDLE_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span> <span class="token comment">// 1073741823 (2^30 - 1)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> LowPriority<span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span> <span class="token comment">// 10000</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> NormalPriority<span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span> <span class="token comment">// 5000</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 计算任务的过期时间, 任务开始时间 + timeout</span>
  <span class="token comment">// 若是立即执行的优先级(IMMEDIATE_PRIORITY_TIMEOUT(-1))</span>
  <span class="token comment">// 它的过期时间是 startTime - 1, 意味着立刻就过期</span>
  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> timeout<span class="token punctuation">;</span>

  <span class="token comment">/*
   * (3
   */</span>
  <span class="token comment">// 创建调度任务</span>
  <span class="token keyword">var</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> taskIdCounter<span class="token operator">++</span><span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span> <span class="token comment">// 调度的任务</span>
    priorityLevel<span class="token punctuation">,</span> <span class="token comment">// 任务优先级</span>
    startTime<span class="token punctuation">,</span> <span class="token comment">// 任务开始的时间, 表示任务何时才能执行</span>
    expirationTime<span class="token punctuation">,</span> <span class="token comment">// 任务的过期时间</span>
    sortIndex<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 在小顶堆队列中排序的依据</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newTask<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token comment">// 解析没有提到这个，貌似是debug用的</span>

  <span class="token comment">/*
   * (4
   */</span>
  <span class="token comment">// startTime &gt; currentTime 说明任务无需立刻执行</span>
  <span class="token comment">// 故放到 timerQueue 中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">&gt;</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// timerQueue 是通过 startTime 判断优先级的,</span>
    <span class="token comment">// 故将 startTime 设为 sortIndex 作为优先级依据</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
    <span class="token function">push</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 taskQueue 是空的, 并且当前任务优先级最高</span>
    <span class="token comment">// 那么这个任务就应该优先被设为 isHostTimeoutScheduled</span>
    <span class="token comment">// 我对isHostTimeoutScheduled的理解就是，表示现在有没有任务被安排延迟进入任务队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果超时调度已经在执行了, 就取消掉（防止被执行多次）</span>
      <span class="token comment">// 因为当前这个任务是最高优的, 需要先处理当前这个任务</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Schedule a timeout.</span>
      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// startTime &lt;= currentTime 说明任务已过期</span>
    <span class="token comment">// 需将任务放到 taskQueue</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
    <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markTaskStart</span><span class="token punctuation">(</span>newTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      newTask<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果目前正在对某个过期任务进行调度,</span>
    <span class="token comment">// 当前任务需要等待下次时间片让出时才能执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPerformingWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newTask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="getcurrenttime"><a href="#getcurrenttime" class="header-anchor">#</a> getCurrentTime</h2> <p>获取当前时间用的，优先使用performance.now（返回一个DOMHighResTimeStamp），其次是Date.now</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> getCurrentTime<span class="token punctuation">;</span>
<span class="token keyword">const</span> hasPerformanceNow <span class="token operator">=</span>
  <span class="token keyword">typeof</span> performance <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> performance<span class="token punctuation">.</span>now <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>hasPerformanceNow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> localPerformance <span class="token operator">=</span> performance<span class="token punctuation">;</span>
  <span class="token function-variable function">getCurrentTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> localPerformance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> localDate <span class="token operator">=</span> Date<span class="token punctuation">;</span>
  <span class="token keyword">const</span> initialTime <span class="token operator">=</span> localDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function-variable function">getCurrentTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> localDate<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> initialTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="request-cancel-hosttimeout"><a href="#request-cancel-hosttimeout" class="header-anchor">#</a> request/cancel HostTimeout</h2> <p>用来设置/取消执行延迟的一对方法。其实就是个延迟调用，为了让未过期的任务能恰好在过期的时候被调用。它专门处理timerQueue里面的任务</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  taskTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>taskTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  taskTimeoutID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>入口中，传给requestHostTimeout的延迟时间是startTime - currentTime，因为未过期的任务的startTime是未来的一个时刻。其实这个值就等于option中设置的delay。</p> <p><strong>具体的运行逻辑还是看看上面入口函数的源码吧</strong></p> <h2 id="handletimeout"><a href="#handletimeout" class="header-anchor">#</a> handleTimeout</h2> <p>被传给requestHostTimeout的callback，字面意思是处理超时。它主要用来更新timerQueue和taskQueue，发现timerQueue中过期的任务就放入taskQueue，如果接下来没有任务正在调度，就先查看taskQueue中是否存在任务，如果有的话就先flush（就是把它们执行了）如果没有就递归执行requestHostTimeout。</p> <p>联系上面的requestHostTimeout，这块儿的逻辑应该是这样的：</p> <ol><li>在调度一个未过期任务进入timerQueue的时候，会让它在过期时刻调用handleTimeout</li> <li>handleTimeout检查两个队列（通过advanceTimers方法，它会把过期的放进taskQueue）</li> <li>因为handleTimeout一般是在有任务过期的时候调用的，所以这时候taskQueue会有任务，就用requestHostCallback(flushWork)把它执行了</li> <li>没有任务过期的话，就对timerQueue中的第一个任务设置requestHostTimeout</li></ol> <p>总之这个方法就是把timerQueue的任务转移到taskQueue中，并调用requestHostCallback执行已过期任务</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleTimeout</span><span class="token punctuation">(</span><span class="token parameter">currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 更新 timerQueue 和 taskQueue 两个序列</span>
  <span class="token comment">// 如果发现 timerQueue 有过期的, 就放到 taskQueue 中</span>
  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 检查是否已经开始调度</span>
  <span class="token comment">// 如果正在调度, 就什么都不做</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 taskQueue 中有任务, 那就先去执行已过期的任务</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果没有过期任务, 那就接着对最高优的第一个未过期的任务</span>
      <span class="token comment">// 继续重复这个过程, 直到它可以被放置到 taskQueue</span>
      <span class="token keyword">const</span> firstTimer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTimer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> firstTimer<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="advancedtimers"><a href="#advancedtimers" class="header-anchor">#</a> advancedTimers</h2> <p>上面提到的，它检查timerQueue中过期的任务，放进taskQueue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">advanceTimers</span><span class="token punctuation">(</span><span class="token parameter">currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>timer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">.</span>callback <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Timer was cancelled.</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 开始时间小于等于当前时间, 说明已过期,</span>
      <span class="token comment">// 从 taskQueue 移走, 放到 taskQueue</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">.</span>startTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// taskQueue 是通过 expirationTime 判断优先级的,</span>
      <span class="token comment">// expirationTime 越小, 说明越紧急, 它就应该放在 taskQueue 的最前面</span>
      timer<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> timer<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
      <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markTaskStart</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timer<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 开始时间大于当前时间, 说明未过期, 任务仍然保留在 timerQueue</span>
      <span class="token comment">// 任务进来的时候, 开始时间默认是当前时间, 如果进入调度的时候传了延迟时间, 开始时间则是当前时间与延迟时间的和</span>
      <span class="token comment">// 开始时间越早, 说明会越早开始, 排在最小堆的前面</span>
      <span class="token comment">// Remaining timers are pending.</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    timer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="requesthostcallback"><a href="#requesthostcallback" class="header-anchor">#</a> requestHostCallback</h2> <p>react废弃了rAF，因为它容易受到用户切换选项卡，滚动页面等操作的影响。目前scheduler通过MessageChannel来人为控制调度频率，默认时间切片是5ms。MessageChannel相关代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> schedulePerformWorkUntilDeadline<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setImmediate <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">schedulePerformWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span>performWorkUntilDeadline<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 兼容IE</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2<span class="token punctuation">;</span>

  <span class="token comment">// port1 接收调度信号, 来执行 performWorkUntilDeadline</span>
  channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> performWorkUntilDeadline<span class="token punctuation">;</span>

  <span class="token comment">// port 是调度者</span>
  <span class="token function-variable function">schedulePerformWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>requestHostCallback将传进来的callback赋值给全局变量scheduledHostCallback，只要isMessageLoopRunning是false，即没有任务调度，就把它开启，并发送信号给port1进行调度：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">requestHostCallback</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduledHostCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMessageLoopRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// postMessage, 告诉 port1 来执行 performWorkUntilDeadline 方法</span>
    <span class="token function">schedulePerformWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="performworkuntildeadline"><a href="#performworkuntildeadline" class="header-anchor">#</a> performWorkUntilDeadline</h2> <p>实际干活的方法，port1收到信号后执行的函数。它会在时间片内执行任务，没执行完就会用一个新的调度者继续调度。</p> <p>它首先会判断scheduledHostCallback，存在才说明有任务需要被执行，执行的deadline是当前时刻加上yieldInterval（也就是默认的5ms）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">performWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 时间分片</span>
    deadline <span class="token operator">=</span> currentTime <span class="token operator">+</span> yieldInterval<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hasTimeRemaining <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> hasMoreWork <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// scheduledHostCallback 去执行真正的任务</span>
      <span class="token comment">// 如果返回 true, 说明当前任务被中断了</span>
      <span class="token comment">// 会再让调度者调度一个执行者继续执行任务</span>
      <span class="token comment">// 下面讲 workLoop 方法时会说到中断恢复的逻辑, 先留个坑</span>
      hasMoreWork <span class="token operator">=</span> <span class="token function">scheduledHostCallback</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasMoreWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果任务中断了(没执行完), 就说明 hasMoreWork 为 true</span>
        <span class="token comment">// 这块类似于递归, 就再申请一个调度者来继续执行该任务</span>
        <span class="token function">schedulePerformWorkUntilDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 否则当前任务就执行完了</span>
        <span class="token comment">// 关闭 isMessageLoopRunning</span>
        <span class="token comment">// 并将 scheduledHostCallback 置为 null</span>
        isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        scheduledHostCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Yielding to the browser will give it a chance to paint, so we can</span>
  <span class="token comment">// reset this.</span>
  needsPaint <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>hasMoreWork字段是判断任务完成的标记，后面workLoop再深入</p> <h2 id="flushwork"><a href="#flushwork" class="header-anchor">#</a> flushWork</h2> <p>requestHostCallback(flushWork)的时候传入的参数，被赋值给了全局变量scheduledHostCallback，在performWorkUntilDeadline中也调用了scheduledHostCallback。flushWork，顾名思义，把任务从马桶里面冲下去，它返回一个workLoop，帮助performWorkUntilDeadline中的hasMoreWork进行判断</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">markSchedulerUnsuspended</span><span class="token punctuation">(</span>initialTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 由于 requestHostCallback 并不一定立即执行传入的回调函数</span>
  <span class="token comment">// 所以 isHostCallbackScheduled 状态可能会维持一段时间</span>
  <span class="token comment">// (isHostCallbackScheduled这块儿逻辑需要仔细看看)</span>
  <span class="token comment">// 等到 flushWork 开始处理任务时, 则需要释放该状态以支持其他的任务被 schedule 进来</span>
  isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// 因为已经在执行 taskQueue 的任务了</span>
  <span class="token comment">// 所以不需要等 timerQueue 中的任务过期了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  isPerformingWork <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> previousPriorityLevel <span class="token operator">=</span> currentPriorityLevel<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">workLoop</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> initialTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">markTaskErrored</span><span class="token punctuation">(</span>currentTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
          currentTask<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// No catch in prod code path.</span>
      <span class="token keyword">return</span> <span class="token function">workLoop</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> initialTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行完任务后还原这些全局状态</span>
    currentTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    currentPriorityLevel <span class="token operator">=</span> previousPriorityLevel<span class="token punctuation">;</span>
    isPerformingWork <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">markSchedulerSuspended</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="workloop"><a href="#workloop" class="header-anchor">#</a> workLoop</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> initialTime<span class="token punctuation">;</span>

  <span class="token comment">// 因为是个异步的, 需要再次调整一下 timerQueue 跟 taskQueue</span>
  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 最紧急的过期任务</span>
  currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    currentTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>enableSchedulerDebugging <span class="token operator">&amp;&amp;</span> isSchedulerPaused<span class="token punctuation">)</span> <span class="token comment">// 用于 debugger, 不管</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 任务中断!!!</span>
    <span class="token comment">// 时间片到了, 但 currentTask 未过期, 跳出循环</span>
    <span class="token comment">// 当前任务就被中断了, 需要放到下次 workLoop 中执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> currentTime <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining <span class="token operator">||</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This currentTask hasn't expired, and we've reached the deadline.</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 清除掉 currentTask.callback</span>
      <span class="token comment">// 如果下次迭代 callback 为空, 说明任务执行完了</span>
      currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      currentPriorityLevel <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>priorityLevel<span class="token punctuation">;</span>

      <span class="token comment">// 已过期</span>
      <span class="token keyword">const</span> didUserCallbackTimeout <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">;</span>
      <span class="token comment">// 判断任务是否过期</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markTaskRun</span><span class="token punctuation">(</span>currentTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 执行任务</span>
      <span class="token keyword">const</span> continuationCallback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>didUserCallbackTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果产生了连续回调, 说明出现了中断</span>
      <span class="token comment">// 故将新的 continuationCallback 赋值 currentTask.callback</span>
      <span class="token comment">// 这样下次恢复任务时, callback 就接上趟了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> continuationCallback <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> continuationCallback<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">markTaskYield</span><span class="token punctuation">(</span>currentTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">markTaskCompleted</span><span class="token punctuation">(</span>currentTask<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
          currentTask<span class="token punctuation">.</span>isQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果 continuationCallback 不是 Function 类型, 说明任务完成!!!</span>
        <span class="token comment">// 否则, 说明这个任务执行完了, 可以被弹出了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 上面执行任务会消耗一些时间, 再次重新更新两个队列</span>
      <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 上面的 if 清空了 currentTask.callback, 所以</span>
      <span class="token comment">// 如果 callback 为空, 说明这个任务就执行完了, 可以被弹出了</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果当前任务执行完了, 那么就把下一个最高优的任务拿出来执行, 直到清空了 taskQueue</span>
    <span class="token comment">// 如果当前任务没执行完, currentTask 实际还是当前的任务, 只不过 callback 变成了 continuationCallback</span>
    currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 任务恢复!!!</span>
  <span class="token comment">// 上面说到 ddl 到了, 但 taskQueue 还没执行完(也就是任务被中断了)</span>
  <span class="token comment">// 就返回 true, 这就是恢复任务的标志</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若任务完成!!!, 去 timerQueue 中找需要最早开始执行的那个任务</span>
    <span class="token comment">// 进行 requestHostTimeout 调度那一套</span>
    <span class="token keyword">const</span> firstTimer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTimer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> firstTimer<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>workLoop在一个时间片内执行currentTask的callback，在开始执行的时候先用continuationCallback把currentTask.callback的值存起来，再把它设置为null，如果执行完成，就把这个任务从堆顶弹出，否则就把currentTask.callback重新设置成新的continuationCallback，这样下一个时间片就能继续了。最后，在执行完任务的情况下，从taskQueue里面再拿一个任务出来作为currentTask。</p> <p>workLoop的返回值是这样判断的：如果currentTask存在，说明任务被中断了，需要继续，就返回true。否则就去timerQueue里面找一个任务执行requestHostTimeout，并返回false</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/Fe/es6/手promise.html" class="prev">
        手写Promise
      </a></span> <span class="next"><a href="/note/Fe/react/fiber.html">
        Fiber
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.5fd906df.js" defer></script><script src="/note/assets/js/2.928e56f7.js" defer></script><script src="/note/assets/js/28.25ad1a6a.js" defer></script>
  </body>
</html>
